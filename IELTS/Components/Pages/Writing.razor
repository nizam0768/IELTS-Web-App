@page "/dancingTab"
@inject HttpClient Http
@rendermode InteractiveServer
@using System.Text.Json;



<div class="container">
    <h1>Writing Section-A</h1>
    <label class="btn btn-warning">Bar</label><br /><br />
    <p>The graph shows the number of fatal injuries (resulting in death) of workers in New Zealand between 1992 and 2010. Summarize the information by selecting and reporting the main features, and make comparison where relevant.</p>
    <div class="containerimg">
        <img src="Images/fatal injuries (resulting in death) of workers in New Zealand.png" />
    </div>
    <div class="d-inline-flex align-items-center gap-2 rounded-container">
        <i class="fa-solid fa-pen-to-square"></i>
        <button @onclick="Write">Write on this topic</button>
    </div>
    @if (textWrite)
    {
        <div>
            <InputTextArea class="form-control" style="height: 200px" @bind-Value="promptText"></InputTextArea>
            <br />
            <div class="d-inline-flex align-items-center gap-2 rounded-container">
                <i class="fa-solid fa-star-of-life"></i>
                <button @onclick="SendPrompt" disabled="@isDisabled">Enhance</button>
            </div>
            @* <button class="btn btn-secondary" @onclick="SendPrompt">Send</button> *@
        </div>
    }

    @if (textEnhance)
    {
        <div>
            <InputTextArea class="form-control" style="height: 200px; margin-bottom:10px" @bind-Value="responseText"></InputTextArea>
        </div>
    }
</div>

@code {
    private bool textEnhance = false;
    private bool textWrite = false;
    private bool isDisabled = false;
    private string promptText = string.Empty;
    private string responseText = "";

    private void Write()
    {
        textWrite = true;
    }
    private async Task SendPrompt()
    {
        isDisabled = true;
        var requestPayload = new
        {
            messages = new[]
            {
                new { role = "user", content = "Enhance the text in 150 words only that score above 8 band in IELTS writing task A." + promptText }
            },
            model = "meta-llama/Llama-3.3-70B-Instruct:cerebras"
        };

        var request = new HttpRequestMessage(HttpMethod.Post, "https://router.huggingface.co/v1/chat/completions")
        {
            Content = JsonContent.Create(requestPayload)
        };
        request.Headers.Add("Authorization", "HF_TOKEN");

        try
        {
            var response = await Http.SendAsync(request);
            var result = await response.Content.ReadFromJsonAsync<JsonElement>();

            if (result.TryGetProperty("choices", out var choices) && choices.GetArrayLength() > 0)
            {
                var message = choices[0].GetProperty("message");
                textEnhance = true;
                responseText = message.GetProperty("content").GetString();
            }
            else
            {
                responseText = "No valid response received.";
            }
            isDisabled = false;
        }
        catch (Exception ex)
        {
            isDisabled = false;
            responseText = $"Error: {ex.Message}";
        }
    }
}
